# IMPORTING THE MODULES

import pandas as pd
from sklearn.ensemble import ExtraTreesClassifier
from sklearn.feature_selection import SelectFromModel
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score, f1_score
import pickle

# READING AND CLEANING THE DATASET

data = pd.read_csv('malware_dataset.csv', low_memory=True)
data.dropna(inplace=True)

# EXTRACTING FEATURES FROM THE DATASET

data_in = data.drop(["ID", "md5", "legitimate"], axis=1)
labels = data["legitimate"]
extratree = ExtraTreesClassifier().fit(data_in.values, labels.values)
select = SelectFromModel(extratree, max_features=13, prefit=True)
data_in_new = select.transform(data_in.values)

fea_idx = select.get_support(indices=True)

fea_List = []
for i in fea_idx:
    fea_List.append(data_in.columns[i])

# DEFINING THE TRAIN AND TEST DATA

legit_train, legit_test, mal_train, mal_test = train_test_split(data_in_new, labels, test_size=0.2)

# TRAINING THE MODEL WITH RandomForestClassifier

classifier = RandomForestClassifier(n_estimators=50)
classifier.fit(legit_train, mal_train)

# CONVERTING INTO PICKLE FILE

with open('model.pkl', 'wb') as file:
    pickle.dump(classifier, file)
    pickle.dump(fea_List, file)

